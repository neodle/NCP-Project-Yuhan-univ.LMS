<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>로그인 페이지</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: url('backgroundfinal.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .login-box {
      position: absolute;
      top: 70%;
      left: 5%;
      transform: translateY(-40%);
      background: rgba(255, 255, 255, 0.25);
      padding: 40px;
      border-radius: 8px;
      width: 300px;
      backdrop-filter: blur(2px);
    }
    .login-box h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: #333;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .options-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      gap: 8px;
    }
    .options-row label { font-size: 13px; }
    .forgot-link {
      font-size: 13px;
      text-align: right;
      display: block;
      margin: 5px 0 15px;
      color: #5597fc;
      text-decoration: underline;
      cursor: pointer;
    }
    .signup-btn {
      background: none;
      border: 1px solid #ccc;
      padding: 5px 10px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      white-space: nowrap;
    }
    button[type="submit"] {
      width: 100%;
      background: #0f5e71;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .status {
      font-size: 13px;
      color: #333;
      margin-top: 8px;
      min-height: 18px;
    }
  </style>
</head>
<body>
  <div class="login-box">
    <h2>LOGIN</h2>
    <form id="loginForm">
      <input id="login-id" type="text" autocomplete="username" placeholder="사용자 아이디" />
      <input id="login-pw" type="password" autocomplete="current-password" placeholder="비밀번호" />
      <div class="options-row">
        <label><input id="rememberId" type="checkbox" /> 아이디 저장</label>
        <button type="button" class="signup-btn" onclick="location.href='signup.html'">회원가입</button>
      </div>
      <a href="findpw.html" class="forgot-link">암호를 잊어버리셨습니까?</a>
      <button type="submit" id="loginBtn">로그인</button>
      <div class="status" id="statusMsg"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('loginForm');
    const loginIdEl = document.getElementById('login-id');
    const loginPwEl = document.getElementById('login-pw');
    const rememberEl = document.getElementById('rememberId');
    const statusMsg  = document.getElementById('statusMsg');
    const loginBtn   = document.getElementById('loginBtn');

    // ID save, retrieve ID
    const savedId = localStorage.getItem('savedLoginId');
    if (savedId) {
      loginIdEl.value = savedId;
      rememberEl.checked = true;
    }

    // Check login status when page loads (session-based)
    (async () => {
      try {
        const me = await fetch('/api/me').then(r => r.json());
        if (me.logged_in && me.user?.username) {
          statusMsg.textContent = `${me.user.username}님 로그인 상태입니다.`;
          // 이미 로그인된 상태라면 원하면 자동 이동: 
          // location.href = 'main.html';
        }
      } catch (e) { /* 무시 */ }
    })();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusMsg.textContent = '';

      const username = loginIdEl.value.trim();
      const password = loginPwEl.value.trim();
      if (!username || !password) {
        alert('아이디와 비밀번호를 입력해주세요.');
        return;
      }

      // 아이디 저장 체크 처리 (비번은 저장 금지)
      if (rememberEl.checked) localStorage.setItem('savedLoginId', username);
      else localStorage.removeItem('savedLoginId');

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = '로그인 중...';

        // 백엔드 로그인 호출 (WAS의 /login → 프록시 경유: /api/login)
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
          // 같은 오리진이므로 쿠키(세션)는 자동 포함됩니다.
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok && data.success) {
          // 로그인 성공 → 세션 쿠키가 설정됨
          alert('로그인이 완료되었습니다!');
          // 로그인 후 페이지로 이동(원하는 페이지로 바꿔도 OK)
          window.location.href = 'main.html?login=1';
        } else {
          alert('로그인 실패: ' + (data.message || `HTTP ${res.status}`));
        }
      } catch (err) {
        alert('서버 오류: ' + err.message);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = '로그인';
      }
    });
  </script>
</body>
</html>
